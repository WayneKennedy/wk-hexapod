services:
  hexapod:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: hexapod-ros2

    # Network mode for ROS 2 DDS discovery
    network_mode: host

    # Hardware device access
    devices:
      - /dev/i2c-1:/dev/i2c-1       # I2C bus (PCA9685, MPU6050, ADS7830)
      - /dev/spidev0.0:/dev/spidev0.0  # SPI (WS2812 LEDs)
      - /dev/spidev0.1:/dev/spidev0.1
      # Pi 5 GPIO access (lgpio uses gpiochip, not gpiomem)
      - /dev/gpiochip4:/dev/gpiochip4  # Main GPIO chip for user pins
      - /dev/gpiomem4:/dev/gpiomem4    # GPIO memory for Pi 5
      # Pi Camera (OV5647) via libcamera - needs media controller and DMA
      - /dev/video0:/dev/video0
      - /dev/media0:/dev/media0
      - /dev/media1:/dev/media1
      - /dev/dma_heap:/dev/dma_heap
      # Intel RealSense D435i (USB 3.0)
      - /dev/bus/usb:/dev/bus/usb

    # Required for hardware access
    privileged: true

    # Keep container running for development
    stdin_open: true
    tty: true

    # Mount source code for development
    volumes:
      - ./ros2_ws/src:/ros2_ws/src:rw
      - ./config:/ros2_ws/config:ro
      - ./reference:/ros2_ws/reference:ro
      # Face recognition data (training images and encodings)
      - ~/.hexapod:/root/.hexapod:rw
      # Persist build artifacts
      - ros2_build:/ros2_ws/build
      - ros2_install:/ros2_ws/install
      - ros2_log:/ros2_ws/log
      # udev database for libcamera device discovery
      - /run/udev:/run/udev:ro

    # Environment variables
    environment:
      - ROS_DOMAIN_ID=0
      - RMW_IMPLEMENTATION=rmw_fastrtps_cpp
      # For colored output
      - TERM=xterm-256color

    # Restart policy
    restart: unless-stopped

    # Default command - launch robot on boot
    # Override with: docker compose run hexapod bash
    command: >
      bash -c "source /opt/ros/jazzy/setup.bash &&
               source /ros2_ws/install/setup.bash &&
               ros2 launch hexapod_bringup robot.launch.py"

  # Development shell - same as above but doesn't auto-restart
  dev:
    extends:
      service: hexapod
    container_name: hexapod-dev
    restart: "no"
    profiles:
      - dev

volumes:
  ros2_build:
  ros2_install:
  ros2_log:
